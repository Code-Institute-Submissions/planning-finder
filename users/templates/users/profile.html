{% extends "home/base.html" %}
{% load crispy_forms_tags %}
{% load static from staticfiles %}

{% block content %}
<div class="profile-page content-section">
    <h3  class="pt-0 pt-sm-1 pt-md-4">Email</h3>
    <p class="" >{{ user.email }}</p>
    <h3 class="pt-0 pt-sm-1 pt-md-4">Location</h3>
    <div id="map"  class="col-12 col-sm-11" style="height: 500px;"></div>
    <a class="btn btn-outline-success mt-2 mt-sm-4  ml-3" href="{% url 'choose_location' %}">Edit Location</a>
</div>
{% endblock content %}

{% block javascript %}
<script>
    const councilData = "{% static 'data/councils-dublin.geojson' %}"
    const marker_lng = {{ user.profile.location.x }}
    const marker_lat = {{ user.profile.location.y }}
    const latlng = L.latLng(marker_lat, marker_lng);

// create the map object
let map = L.map('map', {
    maxZoom: 20,
    minZoom: 10,
    maxBounds: [
        //south west
        [53.1, -6.7],
        //north east
        [53.7, -5.8]
        ], 
}).setView([marker_lat, marker_lng], 15);

// get the data
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
    maxZoom: 20,
    minZoom: 7,
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1,
    zoomSnap: 0.25,
}).addTo(map);

// add a scale to the map
let scale = L.control.scale().addTo(map);

// set makers for User
L.marker([marker_lat, marker_lng]).addTo(map)
    .bindPopup('To choose a new location, click "Edit Location"')
    .openPopup();

    let councilGeoJSON = fetch(councilData, { mode: 'cors' })
    .then(function (response) {
      return response.ok ? response.json() : Promise.reject(response.status);
    })
    .then(function (response) { 
        console.log(response)
        L.geoJSON(response, {
          interactive: false,
          style: function (feature) {
      
              let councils = /(DUBLIN CITY|FINGAL|SOUTH|DUN LAOGHAIRE)/;
              let fill = (councils.test(feature.properties.ENGLISH)) ? 0 : .5
      
              return {
                  fillOpacity: fill,
                  weight: 1,
                  color: 'black'
              };
          }
      }).addTo(map)
      })
    .catch(function (error) { console.log('Request failed', error) });
</script>

{% endblock javascript %}