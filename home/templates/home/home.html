{% extends "home/base.html" %}
{% load static from staticfiles %}

{% block style %}
<link rel="stylesheet" href="{% static 'libraries/nouislider/nouislider.css' %}">
{% endblock style %}

{% block content %}
<div class="row h-100">
    <div id="list-view" class="col-4 h-100 overflow-auto">
        <div class="position-fixed w-100 ml-n3 collapse" id="collapseExample">
            <div id="application-type-options" class="bg-light border-top card-body position-absolute shadow-sm col-4">
                <button id="pending" type="button" class="btn btn-outline-secondary mt-3 mr-2">Pending</button>
                <button id="granted" type="button" class="btn btn-outline-secondary mt-3 mr-2">Granted</button>
                <button id="refused" type="button" class="btn btn-outline-secondary mt-3 mr-2">Refused</button>
                <button id="invalid" type="button" class="btn btn-outline-secondary mt-3 mr-2">Invalid</button>
                <button id="withdrawn" type="button" class="btn btn-outline-secondary mt-3 mr-2">Withdrawn</button>
                <button id="information" type="button" class="btn btn-outline-secondary mt-3 mr-2">Additional
                    Information</button>
            </div>
        </div>
        <div class="position-fixed w-100 ml-n3 collapse" id="dateSliderMain">
            <div id="price-slider-options" class="bg-light border-top card-body position-absolute shadow-sm col-4">
                <div id="dateSlider" class="m-5"></div>
            </div>
        </div>
    </div>
    <div id="map" class="col-8"></div>
</div>
{% endblock content %}

{% block javascript %}
<script src="{% static 'libraries/nouislider/nouislider.js' %}"></script>
<script src="{% static 'libraries/jquery-scrollintoview/jquery.scrollintoview.min.js' %}"></script>

<script>
    {% if user.is_authenticated and user.profile %}
    let marker_lng = {{ user.profile.location.x }}
    let marker_lat = {{ user.profile.location.y }}
    {% else %}
    let marker_lng = -6.25
    let marker_lat = 53.31
    {% endif %}
    const latlng = L.latLng(marker_lat, marker_lng);

    // create the map object
    let map = L.map('map').setView([marker_lat, marker_lng], 15);

    // variables
    const ONE_WEEK = 7 * 24 * 60 * 60 * 1000;
    const TODAY = Math.floor(Date.now())
    const EIGHT_WEEKS_AGO = TODAY - (8 * ONE_WEEK)
    const applicationList = ['pending', 'granted', 'refused', 'invalid', 'withdrawn', 'information']
    let minDate = Math.round((new Date()).getTime());
    let maxDate = Math.round((new Date()).getTime());;

    let filters = {
        applicationType: ['pending', 'granted', 'refused', 'invalid', 'withdrawn', 'information'],
        dateRange: []
    }

    // get the data
    let planningData = JSON.parse('{{ data| escapejs }}')
    let councilData = JSON.parse('{{ council| escapejs }}')
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        minZoom: 7,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
    }).addTo(map);

    L.marker([marker_lat, marker_lng]).addTo(map)
        .bindPopup('I am in Dublin.<br> Looking for plannings.')
        .openPopup();


    planningGeoJSON = L.geoJSON(planningData, {
        style: function (feature) {
            let colour = 'white';
            let refuse_planning = /refuse/;
            let invalid_planning = /invalid/;
            let withdrawn_planning = /withdrawn/;
            let granted_planning = /(grant|split)/;
            let information = /additional/;

            if (feature.properties['Decision'] == null) {
                feature.properties['PlanningStatus'] = 'pending';
                colour = 'orange';
            } else {
                if (refuse_planning.test(feature.properties['Decision'].toLowerCase())) {
                    feature.properties['PlanningStatus'] = 'refused';
                    colour = 'red';
                }
                if (invalid_planning.test(feature.properties['Decision'].toLowerCase())) {
                    feature.properties['PlanningStatus'] = 'invalid';
                    colour = 'brown';
                }
                if (withdrawn_planning.test(feature.properties['Decision'].toLowerCase())) {
                    feature.properties['PlanningStatus'] = 'withdrawn';
                    colour = 'blue'
                };
                if (granted_planning.test(feature.properties['Decision'].toLowerCase())) {
                    feature.properties['PlanningStatus'] = 'granted';
                    colour = 'green';
                }
                if (information.test(feature.properties['Decision'].toLowerCase())) {
                    feature.properties['PlanningStatus'] = 'information';
                    colour = 'purple';
                }
            }

            return {
                fillOpacity: 0.1,
                fillColor: colour,
                color: colour,
                opacity: 0.3,
                radius: 10
            };
        },

        // create list items
        pointToLayer: function (geoJSONPoint, latlng) {
            if (geoJSONPoint.properties['ReceivedDate'] < minDate) minDate = geoJSONPoint.properties['ReceivedDate']

            geoJSONPoint.properties['ApplicationUrl'] = selectCouncil(geoJSONPoint)

            divhtml = createListItem(geoJSONPoint)
            $('#list-view').append(divhtml);

            return L.circle(latlng)
        },

        onEachFeature: function (feature, layer) {
            layer.on('click', function () {
                let id = $('#' + feature.properties['ApplicationNumber'].replace(/\//g, ""))
                $(id).scrollintoview({ duration: 100, complete: id.css("background-color", "lightgrey") });
            });
        }
    }
    ).addTo(map);

    councilGeoJSON = L.geoJSON(councilData, {
        interactive: false,
        style: function (feature) {

            let councils = /(DUBLIN CITY|FINGAL|SOUTH|DUN LAOGHAIRE)/;
            let fill = (councils.test(feature.properties.ENGLISH)) ? 0 : .5

            return {
                fillOpacity: fill,
                weight: 1,
                color: 'black'
            };
        }
    }).addTo(map)

    councilGeoJSON.bringToBack()


    // change marker size on zoom
    map.on('zoomend', function () {
        if (map.getZoom() > 17) {planningGeoJSON.eachLayer(function (layer) { layer.setRadius(5) })}
        else if (map.getZoom() == 17) {planningGeoJSON.eachLayer(function (layer) { layer.setRadius(10) })}
    });

    map.fitBounds(planningGeoJSON.getBounds(), {padding: [20, 20]});

    // filtering planning application
    $(document).ready(function () {
        const applicationList = ['pending', 'granted', 'refused', 'invalid', 'withdrawn', 'information']
        applicationList.forEach(function (appType) {
            $('#' + appType).click(function () {
                if (filters.applicationType.includes(appType)) {
                    filters.applicationType = filters.applicationType.filter(e => e != appType)
                } else {
                    filters.applicationType.push(appType)
                }
                planningGeoJSON.eachLayer(function (layer) {
                    filterPlanningGeoJSON(layer)
                })
                // planningGeoJSON.eachLayer(filterPlanningGeoJSON)

                $(this).toggleClass("active");
            });
        })
    });

    // date slider
    let slider = document.getElementById('dateSlider');
    let months = [
        "January", "February", "March",
        "April", "May", "June", "July",
        "August", "September", "October",
        "November", "December"
    ];

    filters.dateRange = [minDate, maxDate]
    noUiSlider.create(slider, {
        start: [minDate, maxDate],
        step: ONE_WEEK,
        tooltips: true,
        connect: true,
        format: {
            to: function (value) {
                var date = new Date(value);
                var month = date.getMonth();
                let year = date.getFullYear();
                var formattedTime = months[date.getMonth()] + '/' + year;
                return formattedTime;
            },
            from: Number
        },
        range: {
            'min': minDate,
            'max': maxDate
        }
    }).on('slide', function (e) {
        let minFilterDate = document.getElementsByClassName('noUi-handle-lower')[0].getAttribute('aria-valuenow')
        let maxFilterDate = document.getElementsByClassName('noUi-handle-upper')[0].getAttribute('aria-valuenow')
        filters.dateRange = [minFilterDate, maxFilterDate]

        planningGeoJSON.eachLayer(function (layer) {
            filterPlanningGeoJSON(layer)
        })
    });

    function filterPlanningGeoJSON(layer) {
        let appId = $('#' + layer.feature.properties['ApplicationNumber'].replace(/\//g, ""));
        let appDate = layer.feature.properties['ReceivedDate']
        let appStatus = layer.feature.properties['PlanningStatus']
        let numberOfTrue = 0;
        if (appDate > filters.dateRange[0] && appDate < filters.dateRange[1]) {
            numberOfTrue += 1;
        }
        if (filters.applicationType.includes(appStatus)) {
            numberOfTrue += 1;
        }
        if (numberOfTrue == 2) {
            appId.show();
            layer.addTo(map)
        }
        else {
            appId.hide();
            map.removeLayer(layer)
        }
    }

    function selectCouncil(geoJSONPoint) {
        let applicationUrl = null
        if (geoJSONPoint.properties['LinkAppDetails'] != null) {
            applicationUrl = geoJSONPoint.properties['LinkAppDetails']
        } else if (geoJSONPoint.properties['PlanningAuthority'] == "Dublin City Council") {
            applicationUrl = "http://www.dublincity.ie/swiftlg/apas/run/WPHAPPDETAIL.DisplayUrl?theApnID=" + geoJSONPoint.properties['ApplicationNumber']
        } else if (geoJSONPoint.properties['PlanningAuthority'] == "Fingal County Council") {
            applicationUrl = "http://planning.fingalcoco.ie/swiftlg/apas/run/WPHAPPDETAIL.DisplayUrl?theApnID=" + geoJSONPoint.properties['ApplicationNumber']
        } else if (geoJSONPoint.properties['PlanningAuthority'] == "South Dublin County Council") {
            applicationUrl = "http://www.sdublincoco.ie/Planning/Details?regref=" + geoJSONPoint.properties['ApplicationNumber']
        } else if (geoJSONPoint.properties['PlanningAuthority'] == "Dun Laoghaire Rathdown County Council") {
            applicationUrl = "http://planning.dlrcoco.ie/swiftlg/apas/run/WPHAPPDETAIL.DisplayUrl?theApnID=" + geoJSONPoint.properties['ApplicationNumber']
        } else {
            applicationUrl = null
        }

        return applicationUrl;
    }

    function createListItem(geoJSONPoint){
        divhtml = `
        <div id="${geoJSONPoint.properties['ApplicationNumber'].replace(/\//g, "")}" class="list-item" >
            Application: ${geoJSONPoint.properties['ApplicationNumber']} <br>
            ReceivedDate: ${new Date(geoJSONPoint.properties['ReceivedDate']).toLocaleDateString("en-GB")} <br>
            Status: ${geoJSONPoint.properties['ApplicationStatus']} <br>
            Decision: ${geoJSONPoint.properties['Decision']} <br>
            LinkAppDetails: ${geoJSONPoint.properties['LinkAppDetails']} <br>
            <a target="_blank" href="${geoJSONPoint.properties['ApplicationUrl']}">Link</a>
            <hr>
        </div>`

        return divhtml
    }


</script>
{% endblock javascript %}